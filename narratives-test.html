<!DOCTYPE html>
<html lang="en">

    <head>
        <!-- Google Fonts -->
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap"
        rel="stylesheet">
    
        <!--Javascript for navbar-->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
        <!-- meta -->
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
    
        <!-- Bootstrap -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    
        <!-- Font -->
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap"
        rel="stylesheet">
    
        <!-- CSS -->
        <link rel="stylesheet" type="text/css" href="css/colors.css">
        <link rel="stylesheet" type="text/css" href="css/style.css">
        <link rel="stylesheet" type="text/css" href="css/media.css">
    
        <title>Microcosm: Hidden Worlds Within</title>
    </head>

    <body>
        <header>
            <!-- Documentation for navbar at https://getbootstrap.com/docs/5.3/components/navbar/#how-it-works -->
            <nav class="navbar navbar-expand-lg bg-body-tertiary">
                <div class="container-fluid">
                    <a class="navbar-brand" href="#">
                        <img src="icons/logo/logo.png" alt="Logo" style="height: 40px;">
                    </a>
                    <button class="navbar-toggler" type="button" data-bs-toggle="modal" data-bs-target="#navbarModal"
                    aria-controls="navbarModal" aria-expanded="false" aria-label="Toggle navigation">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                    <div class="collapse navbar-collapse" id="navbarNav">
                        <ul class="navbar-nav">
                            <li class="nav-item">
                                <a class="nav-link" aria-current="page" href="narratives.html">Narratives</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#">Map</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#">Documentation</a>
                            </li>
                        </ul>
                    </div>
                </div>
            </nav>
        </header>
        
        <!-- Modal Structure -->
        <div class="modal fade" id="navbarModal" tabindex="-1" aria-labelledby="navbarModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header">
                <a class="modal-title" id="navbarModalLabel" href="#">
                    <img src="icons/logo/logo_full.png" alt="Logo" style="height: 40px;">
                </a>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                <!-- Navbar content duplicated inside the modal -->
                <ul class="navbar-nav">
                    <li class="nav-item">
                    <a class="nav-link active" aria-current="page" href="narratives.html">Narratives</a>
                    </li>
                    <li class="nav-item">
                    <a class="nav-link" href="#">Map</a>
                    </li>
                    <li class="nav-item">
                    <a class="nav-link" href="#">Documentation</a>
                    </li>
                </ul>
                </div>
            </div>
            </div>
        </div>
        
        <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script> 
            <main id ="my-main">
                <div class="container-fluid p-0 mt-5">
                    <div class="text-center">
                        <h1>Narratives</h1>
                    </div>
                <div class="nav-for-scroll sticky-top mt-5">
                    <ul class="nav nav-pills nav-justified" id="nav-narratives">
                    </ul>
                </div>  
              
            </main>
            <footer>

            </footer>
            <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
            <script>
                let narrativeData = {};
                let narratives = [];
              // Intersection Observer for scroll-based activation
                document.addEventListener("DOMContentLoaded", async function(event) {
                    fetch('narrative-data.json')
                    .then(response => response.json())
                    .then(data => {	
                        narrativeData = data;
                        showNarrativesNav();
                    })
                    .catch(error => {
                        console.error("Error:", error);
                    });
                });

                function showNarrativesNav() {
                    narratives = narrativeData.narratives;
                    let firstNarrativeName = "";
                    for (let i in narratives) {
                        let narrativeName = narratives[i]["name"];
                        let narrativeId = "#" + narratives[i]["name"];
                        if (i == 0) {
                            byId("nav-narratives").innerHTML += "<li class=\"nav-item narrative-item\"><a href=\"" + narrativeId +"\" class=\"nav-link active\" id=\"first-narrative\">" + narrativeName + "</a></li>";
                            firstNarrativeName = narrativeName;
                        } else {
                            byId("nav-narratives").innerHTML += "<li class=\"nav-item narrative-item\"><a href=\"" + narrativeId + "\" class=\"nav-link\">" + narrativeName + "</a></li>";
                        };
                    
                    };
                    showCards();
                }

                function showCards() {
                    for (let i = 0; i < narratives.length; i++) {
                        let narrativeName = narratives[i]["name"];
                        let narrativeId = "#" + narratives[i]["name"];
                        let main = document.getElementsByTagName("main");
                        let subnarratives = narratives[i]["subnarratives"];
                        let cards = generateCards(subnarratives);
                        let newCode = "<div class=\"container-fluid mt-5 section\" id=\"" + narrativeId +"\"><h2>" + narrativeName + "</h2><div class=\"d-flex flex-row\">" + cards + "</div></div>";
                        console.log(newCode);
                        main.innerHTML += newCode;
                    };
                }

                
                function generateCards(param) {
                    const mySheet = document.styleSheets[5];

                    let result = ""
                    for (let i = 0; i < param.length; i++) {
                        let subnarrativeName = param[i]["name"];
                        let subnarrativePic = param[i]["icon"];
                        let subnarrativeDesc = param[i]["short-desc"];
                        let backgroundImageClass = "card-img-bg-" + subnarrativeName.replaceAll(" ", "-");
                        result += `<a href="#">
                        <div class="card h-100">
                        <div class="${backgroundImageClass}"></div>
                        <div class="card-body">
                            <h5 class="card-title">${subnarrativeName}</h5>
                            <p class="card-text">${subnarrativeDesc}</p>
                        </div>
                        </div>
                        </a>`;

                        let newRule = `
                            .${backgroundImageClass} {
                                background-image: url("${subnarrativePic}");
                            }
                            `;
                        let ruleIndex = mySheet.insertRule(newRule, mySheet.cssRules.length);
                    };
                    

                    return result;
                }

                function byId(id) {
	                return document.getElementById(id)
                }
                
            
            
            
            
            
        
            function createObserver() {
                const sections = document.querySelectorAll('.section');
                const navLinks = document.querySelectorAll('.nav .nav-link');

                const isMobile = window.matchMedia("(max-width: 991px)").matches;
                const threshold = isMobile ? 0.1 : 0.5;

                const observerOptions = {
                    root: null,
                    rootMargin: '0px',
                    threshold: threshold
                };

                const observer = new IntersectionObserver(entries => {
                    entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        navLinks.forEach(link => {
                        link.classList.toggle('active', link.getAttribute('href') === `#${entry.target.id}`);
                        });
                    }
                    });
                }, observerOptions);

                sections.forEach(section => {
                    observer.observe(section);
                });
            }

            </script>
    </body>
</html>