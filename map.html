<!DOCTYPE html>
<html lang="en">

    <head>
        <!-- Google Fonts -->
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap"
        rel="stylesheet">
    
        <!--Javascript for navbar-->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
        <!-- meta -->
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
    
        <!-- Bootstrap -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    
        <!-- Font -->
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap"
        rel="stylesheet">
    
        <!-- CSS -->
        <link rel="stylesheet" type="text/css" href="css/colors.css">
        <link rel="stylesheet" type="text/css" href="css/style.css">

        <!-- Javascript -->
    
        <title>Microcosm: Hidden Worlds Within</title>
    </head>

    <body>
        <header>
            <!-- Documentation for navbar at https://getbootstrap.com/docs/5.3/components/navbar/#how-it-works -->
            <nav class="navbar navbar-expand-lg bg-body-tertiary">
                <div class="container-fluid">
                    <a class="navbar-brand" href="#">
                        <img src="icons/logo/logo.png" alt="Logo" style="height: 40px;">
                    </a>
                    <button class="navbar-toggler" type="button" data-bs-toggle="modal" data-bs-target="#navbarModal"
                    aria-controls="navbarModal" aria-expanded="false" aria-label="Toggle navigation">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                    <div class="collapse navbar-collapse" id="navbarNav">
                        <ul class="navbar-nav">
                            <li class="nav-item">
                                <a class="nav-link active" aria-current="page" href="narratives.html">Narratives</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#">Map</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#">Documentation</a>
                            </li>
                        </ul>
                    </div>
                </div>
            </nav>
        </header>
        
        <!-- Modal Structure -->
        <div class="modal fade" id="navbarModal" tabindex="-1" aria-labelledby="navbarModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header">
                <a class="modal-title" id="navbarModalLabel" href="#">
                    <img src="icons/logo/logo_full.png" alt="Logo" style="height: 40px;">
                </a>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                <!-- Navbar content duplicated inside the modal -->
                <ul class="navbar-nav">
                    <li class="nav-item">
                    <a class="nav-link active" aria-current="page" href="narratives.html">Narratives</a>
                    </li>
                    <li class="nav-item">
                    <a class="nav-link" href="#">Map</a>
                    </li>
                    <li class="nav-item">
                    <a class="nav-link" href="#">Documentation</a>
                    </li>
                </ul>
                </div>
            </div>
            </div>
        </div>
        
        <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script> 

        <div class="container-fluid mt-5">
            <div class="text-center">
                <h1>Map<h2>
            </div>
            <div class="nav-for-scroll mt-5">
                <ul class="nav nav-pills nav-justified" id="nav-narratives">
                </ul>
            </div>

            <div class="row">
                <div class="col-12 col-lg-6">
                    <div class="map-container" id="map">
                        
                    </div>
                </div>
                <div class="col-12 col-lg-6">
                    <div class="mt-5 d-flex flex-row flex-wrap " id="subnarratives-buttons">
                        
                    </div>
                      
                    <ul class="mt-5" id="list-items">
                    </ul>
                </div>
            </div>
            
                
        </div>
        <footer>
        </footer>
        <script>
            let narratives = {}
            let narrativeData = {};
            let objectData = {};
            let currentNarrative = "";
            let activeState = "";
            let activeSubnarrative = "";

            document.addEventListener("DOMContentLoaded", async function(event) {
                console.log("Starting the narratives");

                // Define the URLs of the JSON files
                const urls = [
                    "narrative-data.json",
                    "data.json"
                ];

                // Use Promise.all to fetch all JSON files concurrently
                Promise.all(urls.map(url => fetch(url).then(response => response.json())))
                    .then(dataArray => {
                        // Process the data from each JSON file
                        narrativeData = dataArray[0];
                        objectData = dataArray[1].objects;
                        console.log(narrativeData);
                        console.log(objectData);
                        showNarrativesNav();
                    })
                    .catch(error => {
                        console.error("Error:", error);
                    });
            });

            function showNarrativesNav() {
                narratives = narrativeData.narratives;
                let firstNarrativeName = "";
                for (let i in narratives) {
                    let narrativeName = narratives[i]["name"];
                    if (i == narratives.length - 1) {
                        byId("nav-narratives").innerHTML += "<li class=\"nav-item narrative-item\"><a onClick=\"showSubnarrativesButtons(this)\" class=\"nav-link active\" id=\"first-narrative\">" + narrativeName + "</a></li>";
                        firstNarrativeName = narrativeName;
                    } else {
                        byId("nav-narratives").innerHTML += "<li class=\"nav-item narrative-item\"><a onClick=\"showSubnarrativesButtons(this)\" class=\"nav-link\">" + narrativeName + "</a></li>";
                    };
                   
                };
                showSubnarrativesButtons(firstNarrativeName);
            }

            function showSubnarrativesButtons(param) {
                let buttonText = "";
                if (typeof param === "string") {
                    buttonText = param;
                } else {
                    buttonText = param.innerText;
                    changeActiveState(param, "nav-narratives");
                };
                let subnarrativesList = "";
                for (let i in narratives) {
                    let narrativeName = narratives[i]["name"];
                    if (narrativeName == buttonText) {
                        subnarrativesList = narratives[i]["subnarratives"];
                    };
                };
                clearElement(byId("subnarratives-buttons"));
                clearElement(byId("list-items"));
                let firstSubnarrative = "";
                for (let x in subnarrativesList) {
                        let subnarrativeName = subnarrativesList[x]["name"];
                        let subnarrativeIcon = subnarrativesList[x]["icon"];
                        if (x == 0) {
                            byId("subnarratives-buttons").innerHTML += `<a class="narrative-button active-narrative mx-3 mb-3" role="button" href="#" onclick="showItems(this)"><img src="${subnarrativeIcon}" alt="${subnarrativeName}" class="narrative-icon"><p>${subnarrativeName}</p></a>`
                            firstSubnarrative = subnarrativeName;
                        } else {                            
                            byId("subnarratives-buttons").innerHTML += `<a class="narrative-button mx-3 mb-3" role="button" href="#" onclick="showItems(this)"><img src="${subnarrativeIcon}" alt="${subnarrativeName}" class="narrative-icon"><p>${subnarrativeName}</p></a>`
                        };
                    };
                
                currentNarrative = buttonText;
                showItems(firstSubnarrative);
                

            }

            function showItems(param) {

                let buttonText = "";
                if (typeof param === "string") {
                   buttonText = param;
                } else {
                    buttonText = String(param.firstChild.alt);
                    clearElement(byId("list-items"));
                    changeActiveState(param, "subnarratives-buttons", true)
                };

                const currentNarrativeObject = narratives.filter( i => i["name"] == currentNarrative);
                const currentSubnarrativeObject = currentNarrativeObject[0]["subnarratives"].filter ( i => i["name"] == buttonText );
                const mapUrl = currentSubnarrativeObject[0]["map"];
                console.log(mapUrl);
                showMap(mapUrl, param);

                let itemList = objectData.filter( i => 
		            i.data.subjectData[currentNarrative]?.includes(buttonText));
                if (itemList.length==0) {
		            itemList = objectData.filter( i => 
		            i.data.picData[currentNarrative]?.includes(buttonText));
                };
                console.log(objectData.length);
                if (itemList.length==0) {
		            itemList = objectData;
                };

                const encodedItemNarrative = encodeURIComponent(currentNarrative);
                const encodedItemSubnarrative = encodeURIComponent(buttonText);
                let encodedItemId = "";

                for (x in itemList) {
                    let itemId = itemList[x]["id"];
                    let itemName = itemList[x]["name"];
                    encodedItemId = encodeURIComponent(itemId);
                    byId("list-items").innerHTML += `<li><a href="app.html?id=${encodedItemId}&narrative=${encodedItemNarrative}&subnarrative=${encodedItemSubnarrative}">${itemId} ${itemName}</a></li>`;
                };
                console.log(buttonText);
            }

            function showMap(url, subnarrativeName) {
                byId("map").innerHTML = `<img src="${url}" alt="${subnarrativeName} map" />`;
            }

            function changeActiveState(objectToAdd, idToRemove, isSubnarrativeButton=false) {
                if (isSubnarrativeButton == true) {  
                    const nodes = byId(idToRemove).childNodes;
                    console.log(nodes);
                    for (let i = 0; i < nodes.length; i++) {
                        if (nodes[i].nodeType === Node.ELEMENT_NODE) {
                            nodes[i].classList.remove("active-narrative");
                        };
                    };
                    objectToAdd.classList.add("active-narrative");
                } else {
                    const nodes = byId(idToRemove).childNodes;
                    console.log(nodes);
                    for (let i = 0; i < nodes.length; i++) {
                        if (nodes[i].nodeType === Node.ELEMENT_NODE) {
                            let son = nodes[i].firstChild;
                            son.classList.remove("active");
                        };
                    };
                    objectToAdd.classList.add("active")
                }
                
            }

            function clearElement(elem) {
                elem.innerHTML = "";
            }

            function inner(id,content, emptyFirst=true) {
	            if(emptyFirst) document.getElementById(id).innerHTML = "" ; 
	            document.getElementById(id).innerHTML += content ; 
            }


            function byId(id) {
                return document.getElementById(id)
            }






            /* document.addEventListener('DOMContentLoaded', function() {
                const image = document.getElementById('image');
                const text = document.getElementById('text');
                let currentImageIndex = 0;
    
                const images = [
                    {
                        src: 'plan of museum/map.png',
                        text: 'Narrative blablablabla room 1'
                    },
                    {
                        src: 'plan of museum/map2.png',
                        text: 'Narrative blablablabla room 2'
                    }
                ];
    
                image.addEventListener('click', function() {
                    currentImageIndex = (currentImageIndex + 1) % images.length;
                    image.src = images[currentImageIndex].src;
                    text.textContent = images[currentImageIndex].text;
                    text.style.display = images[currentImageIndex].text ? 'block' : 'none';
                });
            }); */
        </script>
</body>
</html>